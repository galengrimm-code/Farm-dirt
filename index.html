<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soil Sample Analysis - Map</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Shared styles -->
  <link rel="stylesheet" href="css/styles.css">
  
  <style>
    /* Page-specific styles */
    .main-content {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    
    #map {
      flex: 1;
      min-height: 500px;
    }
    
    .sample-marker {
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .field-mode .sample-marker {
      min-width: 44px !important;
      min-height: 44px !important;
      font-size: 14px !important;
    }
    
    /* Leaflet overrides */
    .leaflet-interactive:focus {
      outline: none !important;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="top-bar">
      <div>
        <h1>üå± Soil Sample Analysis</h1>
        <p>Precision Farms Field Management</p>
      </div>
      
      <nav class="nav-links">
        <a href="index.html" class="nav-link active">üìç Map</a>
        <a href="analysis.html" class="nav-link">üìä Analysis</a>
        <a href="import.html" class="nav-link">üìÅ Import</a>
        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
      </nav>
      
      <div class="auth-section">
        <span class="user-info" id="userInfo"></span>
        <button class="sign-in-btn" id="authBtn" onclick="handleAuth()">
          Sign In with Google
        </button>
      </div>
    </div>
    
    <!-- Controls -->
    <div class="controls-bar">
      <div class="controls-left">
        <div class="control-group">
          <label>FIELD</label>
          <select id="fieldSelect">
            <option value="all">All Fields</option>
          </select>
        </div>
        
        <div class="control-group">
          <label>ATTRIBUTE</label>
          <select id="attributeSelect">
            <option value="P">Phosphorus (P)</option>
            <option value="pH">pH</option>
            <option value="K">Potassium (K)</option>
            <option value="OM">Organic Matter</option>
            <option value="Ca_sat">Calcium %</option>
            <option value="Mg_sat">Magnesium %</option>
            <option value="K_Sat">K Base Sat %</option>
            <option value="H_Sat">H Base Sat %</option>
            <option value="Zn">Zinc</option>
            <option value="Cu">Copper</option>
            <option value="Mn">Manganese</option>
            <option value="Fe">Iron</option>
            <option value="Boron">Boron</option>
            <option value="S">Sulfur</option>
          </select>
        </div>
        
        <div class="control-group">
          <label>YEAR</label>
          <select id="yearSelect">
            <option value="all">All Years</option>
          </select>
        </div>
        
        <div class="control-group">
          <label>VIEW MODE</label>
          <div class="toggle-group">
            <button class="toggle-btn active" id="pointViewBtn">Point Detail</button>
            <button class="toggle-btn" id="fieldViewBtn">Field Average</button>
          </div>
        </div>
      </div>
      
      <div class="controls-right">
        <button class="button" id="fieldModeBtn">üì± Field Mode</button>
        <button class="button" id="refreshBtn">üîÑ Refresh</button>
      </div>
    </div>
    
    <!-- Legend -->
    <div class="legend">
      <span class="legend-label">Legend:</span>
      <div style="width: 100px; height: 16px; background: linear-gradient(to right, #ef4444, #eab308, #22c55e); border-radius: 8px; border: 1px solid #cbd5e1;"></div>
      <span>Low ‚Üí High</span>
    </div>
    
    <!-- Map -->
    <div class="main-content">
      <div id="map"></div>
    </div>
    
    <!-- Status message -->
    <div id="statusMessage"></div>
  </div>

  <!-- Google API -->
  <script src="https://apis.google.com/js/api.js"></script>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- App scripts -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/sheets-api.js"></script>
  
  <script>
    // App state
    let map;
    let sampleData = [];
    let fieldBoundaries = {};
    let settings = {};
    let currentLayers = [];
    let selectedField = 'all';
    let selectedAttribute = 'P';
    let selectedYear = 'all';
    let viewMode = 'point';
    let fieldModeActive = false;
    let gpsMarker = null;
    let gpsCircle = null;
    let gpsWatchId = null;

    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      initMap();
      
      // Try to initialize Google API
      try {
        await SheetsAPI.init();
        SheetsAPI.onSignInChange = handleSignInChange;
        handleSignInChange(SheetsAPI.isSignedIn);
      } catch (error) {
        console.warn('Google API not configured yet:', error);
        Utils.showStatus('Configure Google API in config.js to enable cloud sync', false);
      }
      
      // Set up event listeners
      setupEventListeners();
      
      // Load data from localStorage as fallback
      loadLocalData();
    });

    function initMap() {
      map = L.map('map').setView([CONFIG.DEFAULT_LAT, CONFIG.DEFAULT_LON], CONFIG.DEFAULT_ZOOM);
      
      // Base layers
      const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      });
      
      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles ¬© Esri',
        maxZoom: 19
      });
      
      streetLayer.addTo(map);
      
      L.control.layers({
        "Street Map": streetLayer,
        "Satellite": satelliteLayer
      }, null, { position: 'topright' }).addTo(map);
    }

    function setupEventListeners() {
      document.getElementById('fieldSelect').addEventListener('change', (e) => {
        selectedField = e.target.value;
        updateMap();
        zoomToField(selectedField);
      });
      
      document.getElementById('attributeSelect').addEventListener('change', (e) => {
        selectedAttribute = e.target.value;
        updateMap();
      });
      
      document.getElementById('yearSelect').addEventListener('change', (e) => {
        selectedYear = e.target.value;
        updateMap();
      });
      
      document.getElementById('pointViewBtn').addEventListener('click', () => {
        viewMode = 'point';
        document.getElementById('pointViewBtn').classList.add('active');
        document.getElementById('fieldViewBtn').classList.remove('active');
        updateMap();
      });
      
      document.getElementById('fieldViewBtn').addEventListener('click', () => {
        viewMode = 'field';
        document.getElementById('fieldViewBtn').classList.add('active');
        document.getElementById('pointViewBtn').classList.remove('active');
        updateMap();
      });
      
      document.getElementById('fieldModeBtn').addEventListener('click', toggleFieldMode);
      document.getElementById('refreshBtn').addEventListener('click', loadData);
    }

    async function handleAuth() {
      if (SheetsAPI.isSignedIn) {
        await SheetsAPI.signOut();
      } else {
        await SheetsAPI.signIn();
      }
    }

    function handleSignInChange(isSignedIn) {
      const authBtn = document.getElementById('authBtn');
      const userInfo = document.getElementById('userInfo');
      
      if (isSignedIn) {
        const user = gapi.auth2.getAuthInstance().currentUser.get();
        const profile = user.getBasicProfile();
        userInfo.textContent = profile.getName();
        authBtn.textContent = 'Sign Out';
        loadData();
      } else {
        userInfo.textContent = '';
        authBtn.textContent = 'Sign In with Google';
      }
    }

    async function loadData() {
      if (!SheetsAPI.isSignedIn) {
        loadLocalData();
        return;
      }
      
      Utils.showStatus('Loading data from Google Sheets...', true);
      
      try {
        // Load fields
        const fields = await SheetsAPI.getFields();
        fieldBoundaries = {};
        fields.forEach(field => {
          if (field.boundary) {
            fieldBoundaries[field.name] = field.boundary;
          }
        });
        
        // Load samples
        sampleData = await SheetsAPI.getSamples();
        
        // Load settings
        settings = await SheetsAPI.getSettings();
        
        // Update UI
        updateFieldSelector();
        updateYearSelector();
        updateMap();
        
        // Save to localStorage as backup
        saveLocalData();
        
        Utils.showStatus(`‚úì Loaded ${sampleData.length} samples, ${Object.keys(fieldBoundaries).length} fields`, true);
      } catch (error) {
        console.error('Error loading data:', error);
        Utils.showStatus('Error loading data from Google Sheets', false);
        loadLocalData();
      }
    }

    function loadLocalData() {
      try {
        const savedSamples = localStorage.getItem('soilSamples');
        const savedBoundaries = localStorage.getItem('fieldBoundaries');
        const savedSettings = localStorage.getItem('soilSettings');
        
        if (savedSamples) sampleData = JSON.parse(savedSamples);
        if (savedBoundaries) fieldBoundaries = JSON.parse(savedBoundaries);
        if (savedSettings) settings = JSON.parse(savedSettings);
        
        updateFieldSelector();
        updateYearSelector();
        updateMap();
        
        if (sampleData.length > 0) {
          Utils.showStatus(`Loaded ${sampleData.length} samples from local storage`, true);
        }
      } catch (error) {
        console.error('Error loading local data:', error);
      }
    }

    function saveLocalData() {
      try {
        localStorage.setItem('soilSamples', JSON.stringify(sampleData));
        localStorage.setItem('fieldBoundaries', JSON.stringify(fieldBoundaries));
        localStorage.setItem('soilSettings', JSON.stringify(settings));
      } catch (error) {
        console.error('Error saving local data:', error);
      }
    }

    function updateFieldSelector() {
      const select = document.getElementById('fieldSelect');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="all">All Fields</option>';
      
      const fields = Utils.getUniqueFields(sampleData);
      const boundaryFields = Object.keys(fieldBoundaries);
      const allFields = [...new Set([...fields, ...boundaryFields])].sort((a, b) => 
        a.localeCompare(b, undefined, { numeric: true })
      );
      
      allFields.forEach(field => {
        const option = document.createElement('option');
        option.value = field;
        option.textContent = field;
        select.appendChild(option);
      });
      
      if (allFields.includes(currentValue)) {
        select.value = currentValue;
      }
    }

    function updateYearSelector() {
      const select = document.getElementById('yearSelect');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="all">All Years</option>';
      
      const years = Utils.getUniqueYears(sampleData);
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        select.appendChild(option);
      });
      
      if (years.includes(parseInt(currentValue))) {
        select.value = currentValue;
      }
    }

    function updateMap() {
      // Clear existing layers
      currentLayers.forEach(layer => map.removeLayer(layer));
      currentLayers = [];
      
      // Draw field boundaries
      Object.entries(fieldBoundaries).forEach(([fieldName, polygons]) => {
        if (selectedField !== 'all' && selectedField !== fieldName) return;
        
        const polygonArray = Array.isArray(polygons[0]?.[0]) ? polygons : [polygons];
        
        polygonArray.forEach(coords => {
          const polygon = L.polygon(coords, {
            color: '#22c55e',
            weight: 3,
            fillOpacity: 0.1,
            fillColor: '#22c55e'
          }).addTo(map);
          
          polygon.bindTooltip(fieldName, { permanent: false, direction: 'center' });
          currentLayers.push(polygon);
        });
      });
      
      // Filter samples
      let filteredData = sampleData.filter(s => {
        if (selectedField !== 'all' && s.field !== selectedField) return false;
        if (selectedYear !== 'all' && s.year != selectedYear) return false;
        return true;
      });
      
      if (viewMode === 'point') {
        // Draw individual sample points
        filteredData.forEach(sample => {
          const value = sample[selectedAttribute];
          if (value === undefined || value === null) return;
          
          const color = Utils.getColor(value, selectedAttribute, settings);
          const markerSize = fieldModeActive ? 44 : 32;
          const fontSize = fieldModeActive ? 14 : 11;
          
          const circle = L.circleMarker([sample.lat, sample.lon], {
            radius: markerSize / 2,
            fillColor: color,
            fillOpacity: 0.9,
            color: 'white',
            weight: 2
          }).addTo(map);
          
          const displayValue = Utils.formatNumber(value, selectedAttribute === 'pH' ? 1 : 0);
          
          const icon = L.divIcon({
            html: `<div class="sample-marker" style="width:${markerSize}px;height:${markerSize}px;background:${color};font-size:${fontSize}px;line-height:${markerSize}px;">${displayValue}</div>`,
            className: '',
            iconSize: [markerSize, markerSize],
            iconAnchor: [markerSize/2, markerSize/2]
          });
          
          const marker = L.marker([sample.lat, sample.lon], { icon }).addTo(map);
          
          // Popup with sample details
          const popupContent = `
            <strong>Sample ${sample.sampleId || ''}</strong><br>
            Field: ${sample.field || 'Unknown'}<br>
            Year: ${sample.year || 'Unknown'}<br>
            ${CONFIG.NUTRIENT_NAMES[selectedAttribute] || selectedAttribute}: ${displayValue} ${CONFIG.NUTRIENT_UNITS[selectedAttribute] || ''}
          `;
          marker.bindPopup(popupContent);
          
          currentLayers.push(circle, marker);
        });
      } else {
        // Field average mode
        const fieldGroups = Utils.groupByField(filteredData);
        
        Object.entries(fieldGroups).forEach(([fieldName, samples]) => {
          const avg = Utils.calculateFieldAverage(samples, selectedAttribute);
          if (avg === null) return;
          
          const color = Utils.getColor(avg, selectedAttribute, settings);
          
          // Get field center
          let center;
          if (fieldBoundaries[fieldName]) {
            const polygons = fieldBoundaries[fieldName];
            const allPoints = Array.isArray(polygons[0]?.[0]) ? polygons.flat() : polygons;
            const lats = allPoints.map(p => p[0]);
            const lons = allPoints.map(p => p[1]);
            center = [(Math.min(...lats) + Math.max(...lats)) / 2, (Math.min(...lons) + Math.max(...lons)) / 2];
          } else {
            const lats = samples.map(s => s.lat);
            const lons = samples.map(s => s.lon);
            center = [(Math.min(...lats) + Math.max(...lats)) / 2, (Math.min(...lons) + Math.max(...lons)) / 2];
          }
          
          const displayValue = Utils.formatNumber(avg, 1);
          
          const icon = L.divIcon({
            html: `<div class="sample-marker" style="width:60px;height:60px;background:${color};font-size:16px;line-height:60px;">${displayValue}</div>`,
            className: '',
            iconSize: [60, 60],
            iconAnchor: [30, 30]
          });
          
          const marker = L.marker(center, { icon }).addTo(map);
          marker.bindPopup(`<strong>${fieldName}</strong><br>Avg ${CONFIG.NUTRIENT_NAMES[selectedAttribute]}: ${displayValue}`);
          
          currentLayers.push(marker);
        });
      }
    }

    function zoomToField(fieldName) {
      if (fieldName === 'all') {
        // Zoom to all
        const allCoords = [];
        Object.values(fieldBoundaries).forEach(polygons => {
          const arr = Array.isArray(polygons[0]?.[0]) ? polygons.flat() : polygons;
          allCoords.push(...arr);
        });
        sampleData.forEach(s => allCoords.push([s.lat, s.lon]));
        
        if (allCoords.length > 0) {
          map.fitBounds(allCoords, { padding: [50, 50] });
        }
      } else if (fieldBoundaries[fieldName]) {
        const polygons = fieldBoundaries[fieldName];
        const allCoords = Array.isArray(polygons[0]?.[0]) ? polygons.flat() : polygons;
        map.fitBounds(allCoords, { padding: [50, 50] });
      }
    }

    function toggleFieldMode() {
      fieldModeActive = !fieldModeActive;
      const btn = document.getElementById('fieldModeBtn');
      
      if (fieldModeActive) {
        btn.classList.add('active');
        btn.textContent = 'üì± Field Mode ON';
        document.body.classList.add('field-mode');
        startGPS();
        
        // Hide non-essential UI
        document.querySelector('.controls-left').style.display = 'none';
      } else {
        btn.classList.remove('active');
        btn.textContent = 'üì± Field Mode';
        document.body.classList.remove('field-mode');
        stopGPS();
        
        document.querySelector('.controls-left').style.display = '';
      }
      
      updateMap();
    }

    function startGPS() {
      if (!navigator.geolocation) {
        Utils.showStatus('GPS not supported', false);
        return;
      }
      
      gpsWatchId = navigator.geolocation.watchPosition(
        (position) => {
          const { latitude, longitude, accuracy } = position.coords;
          
          if (gpsMarker) {
            gpsMarker.setLatLng([latitude, longitude]);
            gpsCircle.setLatLng([latitude, longitude]);
            gpsCircle.setRadius(accuracy);
          } else {
            gpsMarker = L.marker([latitude, longitude], {
              icon: L.divIcon({
                html: '<div style="width:20px;height:20px;background:#3b82f6;border:3px solid white;border-radius:50%;box-shadow:0 0 10px rgba(59,130,246,0.5);"></div>',
                className: '',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
              })
            }).addTo(map);
            
            gpsCircle = L.circle([latitude, longitude], {
              radius: accuracy,
              color: '#3b82f6',
              fillColor: '#3b82f6',
              fillOpacity: 0.15,
              weight: 2
            }).addTo(map);
          }
          
          map.setView([latitude, longitude], map.getZoom());
        },
        (error) => {
          Utils.showStatus('GPS error: ' + error.message, false);
        },
        { enableHighAccuracy: true, maximumAge: 5000 }
      );
    }

    function stopGPS() {
      if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
      }
      if (gpsMarker) {
        map.removeLayer(gpsMarker);
        map.removeLayer(gpsCircle);
        gpsMarker = null;
        gpsCircle = null;
      }
    }
  </script>
</body>
</html>
