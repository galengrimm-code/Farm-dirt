<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soil Sample Analysis - Trends</title>
  
  <!-- Shared styles -->
  <link rel="stylesheet" href="css/styles.css">
  
  <style>
    /* Analysis page specific styles */
    .analysis-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    
    .field-selector {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .field-selector label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #475569;
    }
    
    .field-selector select {
      width: 100%;
      max-width: 300px;
      padding: 0.75rem;
      font-size: 1rem;
    }
    
    .summary-card {
      background: #f8fafc;
      border: 2px solid #cbd5e1;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .summary-card h3 {
      margin: 0 0 0.5rem 0;
      color: #1e293b;
    }
    
    .summary-card p {
      margin: 0;
      color: #64748b;
      font-size: 0.875rem;
    }
    
    .trend-card {
      background: white;
      border: 2px solid;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .trend-card.positive {
      background: #f0fdf4;
      border-color: #22c55e;
    }
    
    .trend-card.negative {
      background: #fef2f2;
      border-color: #ef4444;
    }
    
    .trend-card.neutral {
      background: #f8fafc;
      border-color: #94a3b8;
    }
    
    .trend-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    
    .trend-title {
      font-size: 1rem;
      font-weight: 600;
      color: #1e293b;
      margin: 0;
    }
    
    .trend-percent {
      font-size: 1.25rem;
      font-weight: 700;
      text-align: right;
    }
    
    .trend-subtitle {
      font-size: 0.6875rem;
      color: #64748b;
    }
    
    .trend-content {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .trend-values {
      flex: 0 0 130px;
      min-width: 100px;
    }
    
    .trend-values-header {
      font-size: 0.75rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }
    
    .trend-value-row {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.875rem;
    }
    
    .trend-value-row .year {
      color: #64748b;
    }
    
    .trend-value-row .value {
      font-weight: 600;
      color: #1e293b;
    }
    
    .trend-change {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 2px solid;
      font-size: 0.8125rem;
    }
    
    .trend-graph {
      flex: 1;
      min-width: 200px;
    }
    
    .no-data {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      color: #92400e;
    }
    
    /* Comparison mode */
    .comparison-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid #e2e8f0;
    }
    
    .comparison-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .comparison-header h3 {
      margin: 0;
    }
    
    .field-compare-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    
    /* Mobile */
    @media (max-width: 639px) {
      .analysis-container {
        padding: 1rem;
      }
      
      .trend-content {
        flex-direction: column;
      }
      
      .trend-values {
        flex: none;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="top-bar">
      <div>
        <h1>üìä Soil Fertility Trends</h1>
        <p>Multi-Year Analysis</p>
      </div>
      
      <nav class="nav-links">
        <a href="index.html" class="nav-link">üìç Map</a>
        <a href="analysis.html" class="nav-link active">üìä Analysis</a>
        <a href="import.html" class="nav-link">üìÅ Import</a>
        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
      </nav>
      
      <div class="auth-section">
        <span class="user-info" id="userInfo"></span>
        <button class="sign-in-btn" id="authBtn" onclick="handleAuth()">
          Sign In with Google
        </button>
      </div>
    </div>
    
    <!-- Main content -->
    <div class="analysis-container">
      <!-- Field selector -->
      <div class="field-selector">
        <label for="fieldSelect">Select Field to Analyze:</label>
        <select id="fieldSelect">
          <option value="">Loading...</option>
        </select>
      </div>
      
      <!-- Results container -->
      <div id="analysisResults">
        <div class="no-data">
          <p>Select a field to view soil fertility trends</p>
        </div>
      </div>
      
      <!-- Multi-field comparison -->
      <div class="comparison-section" id="comparisonSection" style="display: none;">
        <div class="comparison-header">
          <h3>üìà Field Comparison</h3>
          <button class="button" id="compareBtn">Compare All Fields</button>
        </div>
        <div class="field-compare-grid" id="comparisonGrid"></div>
      </div>
    </div>
    
    <!-- Status message -->
    <div id="statusMessage"></div>
  </div>

  <!-- Google API -->
  <script src="https://apis.google.com/js/api.js"></script>
  
  <!-- App scripts -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/sheets-api.js"></script>
  
  <script>
    // App state
    let sampleData = [];
    let fieldBoundaries = {};
    let settings = {};

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await SheetsAPI.init();
        SheetsAPI.onSignInChange = handleSignInChange;
        handleSignInChange(SheetsAPI.isSignedIn);
      } catch (error) {
        console.warn('Google API not configured:', error);
        loadLocalData();
      }
      
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('fieldSelect').addEventListener('change', (e) => {
        if (e.target.value) {
          analyzeField(e.target.value);
        }
      });
      
      document.getElementById('compareBtn')?.addEventListener('click', compareAllFields);
    }

    async function handleAuth() {
      if (SheetsAPI.isSignedIn) {
        await SheetsAPI.signOut();
      } else {
        await SheetsAPI.signIn();
      }
    }

    function handleSignInChange(isSignedIn) {
      const authBtn = document.getElementById('authBtn');
      const userInfo = document.getElementById('userInfo');
      
      if (isSignedIn) {
        const user = gapi.auth2.getAuthInstance().currentUser.get();
        const profile = user.getBasicProfile();
        userInfo.textContent = profile.getName();
        authBtn.textContent = 'Sign Out';
        loadData();
      } else {
        userInfo.textContent = '';
        authBtn.textContent = 'Sign In with Google';
        loadLocalData();
      }
    }

    async function loadData() {
      Utils.showStatus('Loading data...', true);
      
      try {
        const fields = await SheetsAPI.getFields();
        fieldBoundaries = {};
        fields.forEach(f => {
          if (f.boundary) fieldBoundaries[f.name] = f.boundary;
        });
        
        sampleData = await SheetsAPI.getSamples();
        settings = await SheetsAPI.getSettings();
        
        updateFieldSelector();
        checkShowComparison();
        
        Utils.showStatus(`‚úì Loaded ${sampleData.length} samples`, true);
      } catch (error) {
        console.error('Error loading data:', error);
        Utils.showStatus('Error loading data', false);
        loadLocalData();
      }
    }

    function loadLocalData() {
      try {
        const saved = localStorage.getItem('soilSamples');
        if (saved) sampleData = JSON.parse(saved);
        
        const savedBoundaries = localStorage.getItem('fieldBoundaries');
        if (savedBoundaries) fieldBoundaries = JSON.parse(savedBoundaries);
        
        updateFieldSelector();
        checkShowComparison();
      } catch (e) {
        console.error('Error loading local data:', e);
      }
    }

    function updateFieldSelector() {
      const select = document.getElementById('fieldSelect');
      select.innerHTML = '<option value="">Select a field...</option>';
      
      const fields = Utils.getUniqueFields(sampleData);
      fields.forEach(field => {
        const option = document.createElement('option');
        option.value = field;
        option.textContent = field;
        select.appendChild(option);
      });
    }

    function checkShowComparison() {
      const fields = Utils.getUniqueFields(sampleData);
      const section = document.getElementById('comparisonSection');
      if (fields.length > 1) {
        section.style.display = 'block';
      }
    }

    function analyzeField(fieldName) {
      const fieldSamples = sampleData.filter(s => s.field === fieldName && s.year);
      
      if (fieldSamples.length === 0) {
        document.getElementById('analysisResults').innerHTML = `
          <div class="no-data">
            <p>No samples with year data found for ${fieldName}</p>
          </div>
        `;
        return;
      }
      
      // Group by year
      const yearGroups = Utils.groupByYear(fieldSamples);
      const years = Object.keys(yearGroups).sort();
      
      if (years.length < 2) {
        document.getElementById('analysisResults').innerHTML = `
          <div class="no-data">
            <p>Need at least 2 years of data to analyze trends.<br>Found data for: ${years.join(', ')}</p>
          </div>
        `;
        return;
      }
      
      // Calculate trends for each nutrient
      const trends = calculateTrends(yearGroups, years);
      
      // Display results
      displayTrends(fieldName, trends, years);
    }

    function calculateTrends(yearGroups, years) {
      const trends = {};
      
      CONFIG.NUTRIENT_ORDER.forEach(nutrient => {
        const yearlyAverages = {};
        
        years.forEach(year => {
          const samples = yearGroups[year];
          const values = samples.map(s => s[nutrient]).filter(v => v !== undefined && v !== null && !isNaN(v));
          
          if (values.length > 0) {
            yearlyAverages[year] = values.reduce((a, b) => a + b, 0) / values.length;
          }
        });
        
        if (Object.keys(yearlyAverages).length >= 2) {
          const yearKeys = Object.keys(yearlyAverages).sort();
          const firstYear = yearKeys[0];
          const lastYear = yearKeys[yearKeys.length - 1];
          const firstValue = yearlyAverages[firstYear];
          const lastValue = yearlyAverages[lastYear];
          const change = lastValue - firstValue;
          const changePercent = (change / firstValue) * 100;
          
          trends[nutrient] = {
            years: yearlyAverages,
            firstYear,
            lastYear,
            firstValue,
            lastValue,
            change,
            changePercent,
            direction: change > 0 ? 'increasing' : change < 0 ? 'decreasing' : 'stable'
          };
        }
      });
      
      return trends;
    }

    function displayTrends(fieldName, trends, years) {
      let html = `
        <div class="summary-card">
          <h3>${fieldName}</h3>
          <p>Analyzing trends from ${years[0]} to ${years[years.length - 1]} (${years.length} sample years)</p>
        </div>
      `;
      
      Object.entries(trends).forEach(([nutrient, data]) => {
        const isIncreasing = data.direction === 'increasing';
        const isDecreasing = data.direction === 'decreasing';
        
        // Check if lower is better for this nutrient
        const lowerIsBetter = CONFIG.LOWER_IS_BETTER.includes(nutrient);
        
        let cardClass, color;
        if (lowerIsBetter) {
          cardClass = isIncreasing ? 'negative' : isDecreasing ? 'positive' : 'neutral';
          color = isIncreasing ? '#ef4444' : isDecreasing ? '#22c55e' : '#64748b';
        } else {
          cardClass = isIncreasing ? 'positive' : isDecreasing ? 'negative' : 'neutral';
          color = isIncreasing ? '#22c55e' : isDecreasing ? '#ef4444' : '#64748b';
        }
        
        const arrow = isIncreasing ? 'üìà' : isDecreasing ? 'üìâ' : '‚û°Ô∏è';
        const unit = CONFIG.NUTRIENT_UNITS[nutrient] || '';
        const name = CONFIG.NUTRIENT_NAMES[nutrient] || nutrient;
        
        // Build year values list
        const sortedYears = Object.keys(data.years).sort();
        let valuesHtml = '';
        sortedYears.forEach(year => {
          valuesHtml += `
            <div class="trend-value-row">
              <span class="year">${year}:</span>
              <span class="value">${data.years[year].toFixed(1)} ${unit}</span>
            </div>
          `;
        });
        
        // Build SVG graph
        const graph = createLineGraph(data.years, color);
        
        html += `
          <div class="trend-card ${cardClass}">
            <div class="trend-header">
              <h4 class="trend-title">${arrow} ${name}</h4>
              <div class="trend-percent" style="color: ${color};">
                ${data.changePercent > 0 ? '+' : ''}${data.changePercent.toFixed(1)}%
                <div class="trend-subtitle">${data.firstYear} ‚Üí ${data.lastYear}</div>
                ${lowerIsBetter ? '<div class="trend-subtitle" style="font-style:italic;">* Lower is better</div>' : ''}
              </div>
            </div>
            <div class="trend-content">
              <div class="trend-values">
                <div class="trend-values-header">Field Average</div>
                ${valuesHtml}
                <div class="trend-change" style="border-color: ${color};">
                  <span style="color: #64748b;">Change:</span>
                  <span style="color: ${color}; font-weight: 700;">
                    ${data.change > 0 ? '+' : ''}${data.change.toFixed(1)} ${unit}
                  </span>
                </div>
              </div>
              <div class="trend-graph">
                ${graph}
              </div>
            </div>
          </div>
        `;
      });
      
      if (Object.keys(trends).length === 0) {
        html += `<div class="no-data"><p>No nutrient data available for trend analysis</p></div>`;
      }
      
      document.getElementById('analysisResults').innerHTML = html;
    }

    function createLineGraph(yearlyData, color) {
      const sortedYears = Object.keys(yearlyData).sort();
      const values = sortedYears.map(y => yearlyData[y]);
      
      if (values.length < 2) return '';
      
      const minVal = Math.min(...values) * 0.9;
      const maxVal = Math.max(...values) * 1.1;
      const range = maxVal - minVal || 1;
      
      const width = 320;
      const height = 120;
      const padding = 10;
      const graphWidth = width - padding * 2;
      const graphHeight = height - padding * 2 - 20;
      
      // Create points
      const points = values.map((val, i) => {
        const x = padding + (i / (values.length - 1)) * graphWidth;
        const y = padding + graphHeight - ((val - minVal) / range) * graphHeight;
        return `${x},${y}`;
      }).join(' ');
      
      // Create dots and labels
      let dotsAndLabels = '';
      values.forEach((val, i) => {
        const x = padding + (i / (values.length - 1)) * graphWidth;
        const y = padding + graphHeight - ((val - minVal) / range) * graphHeight;
        dotsAndLabels += `<circle cx="${x}" cy="${y}" r="6" fill="${color}" stroke="white" stroke-width="2"/>`;
        dotsAndLabels += `<text x="${x}" y="${height - 5}" text-anchor="middle" font-size="11" fill="#64748b" font-weight="500">${sortedYears[i]}</text>`;
        dotsAndLabels += `<text x="${x}" y="${y - 12}" text-anchor="middle" font-size="12" fill="#1e293b" font-weight="700">${val.toFixed(1)}</text>`;
      });
      
      return `
        <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="max-width: 400px;">
          <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding - 20}" stroke="#e2e8f0" stroke-width="1"/>
          <line x1="${padding}" y1="${height - padding - 20}" x2="${width - padding}" y2="${height - padding - 20}" stroke="#e2e8f0" stroke-width="1"/>
          <polyline points="${points}" fill="none" stroke="${color}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          ${dotsAndLabels}
        </svg>
      `;
    }

    function compareAllFields() {
      const fields = Utils.getUniqueFields(sampleData);
      const grid = document.getElementById('comparisonGrid');
      
      let html = '';
      
      fields.forEach(fieldName => {
        const fieldSamples = sampleData.filter(s => s.field === fieldName && s.year);
        const yearGroups = Utils.groupByYear(fieldSamples);
        const years = Object.keys(yearGroups).sort();
        
        if (years.length < 2) return;
        
        const trends = calculateTrends(yearGroups, years);
        
        // Show summary for key nutrients
        const keyNutrients = ['pH', 'P', 'K', 'OM'];
        let summaryHtml = '';
        
        keyNutrients.forEach(nutrient => {
          if (trends[nutrient]) {
            const data = trends[nutrient];
            const lowerIsBetter = CONFIG.LOWER_IS_BETTER.includes(nutrient);
            const isGood = lowerIsBetter ? data.direction === 'decreasing' : data.direction === 'increasing';
            const color = isGood ? '#22c55e' : data.direction === 'stable' ? '#64748b' : '#ef4444';
            
            summaryHtml += `
              <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #e2e8f0;">
                <span>${nutrient}</span>
                <span style="color: ${color}; font-weight: 600;">
                  ${data.changePercent > 0 ? '+' : ''}${data.changePercent.toFixed(1)}%
                </span>
              </div>
            `;
          }
        });
        
        html += `
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">${fieldName}</h4>
              <span style="font-size: 0.75rem; color: #64748b;">${years[0]}-${years[years.length-1]}</span>
            </div>
            ${summaryHtml}
            <button class="button" style="width: 100%; margin-top: 0.75rem;" onclick="document.getElementById('fieldSelect').value='${fieldName}'; analyzeField('${fieldName}');">
              View Details
            </button>
          </div>
        `;
      });
      
      grid.innerHTML = html || '<p>No fields with multi-year data</p>';
    }
  </script>
</body>
</html>
